---
phase: 04-whisper-output-normalization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/config.js
  - src/whisper.js
  - src/whisper-server-manager.js
  - .env.example
autonomous: false

must_haves:
  truths:
    - "用户说简体中文时，输出结果为简体中文（不出现繁体字）"
    - "用户说英语时，输出结果为英语"
    - "用户中英混合说话时，输出结果为简体中文+英语混合"
  artifacts:
    - path: "src/config.js"
      provides: "whisperPrompt 配置项"
      contains: "whisperPrompt"
    - path: "src/whisper.js"
      provides: "CLI 模式 --prompt 参数传递"
      contains: "--prompt"
    - path: "src/whisper-server-manager.js"
      provides: "HTTP Server 模式 --prompt 参数传递"
      contains: "--prompt"
  key_links:
    - from: "src/config.js"
      to: "src/whisper.js"
      via: "config.whisperPrompt"
      pattern: "config\\.whisperPrompt"
    - from: "src/config.js"
      to: "src/whisper-server-manager.js"
      via: "config.whisperPrompt"
      pattern: "config\\.whisperPrompt"
---

<objective>
为 Whisper 语音识别添加 Prompt 工程支持，通过 `--prompt` 参数传递简体中文示例文本来引导模型输出简体中文，同时保持英语识别质量。

Purpose: Whisper 模型对中文使用单一的 `zh` 语言代码，无法直接区分简繁体。通过 Prompt 工程（传递简体中文风格示例），可以引导模型输出简体中文字符。

Output: 配置项 `WHISPER_PROMPT` 支持环境变量配置，默认值为编程场景下的简体中文+英语示例文本。CLI 和 HTTP Server 两种模式都正确传递该参数。
</objective>

<execution_context>
@/Users/jiabozhang/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jiabozhang/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-whisper-output-normalization/04-CONTEXT.md
@.planning/phases/04-whisper-output-normalization/04-RESEARCH.md

@src/config.js
@src/whisper.js
@src/whisper-server-manager.js
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: 添加 WHISPER_PROMPT 配置和集成</name>
  <files>
    src/config.js
    src/whisper.js
    src/whisper-server-manager.js
    .env.example
  </files>
  <action>
**Step 1: 修改 src/config.js**
- 添加 `whisperPrompt` 配置项，读取 `process.env.WHISPER_PROMPT`
- 默认值设为编程场景的简体中文示例文本（约 50-100 字符，不超过 224 tokens）：
  ```javascript
  whisperPrompt: process.env.WHISPER_PROMPT ?? '以下是普通话的句子。我在写代码，使用 function 定义函数，通过 API 调用接口。',
  ```
- Prompt 设计原则（来自研究）：
  - 使用简体中文示例文本（不是指令）
  - 包含常见编程术语（function, API 等）
  - 不使用繁体字
  - 限制在 224 tokens 以内

**Step 2: 修改 src/whisper.js**
- 在 `runWhisperCli` 函数中导入 config
- 在 args 数组构建时，如果 `config.whisperPrompt` 非空，添加 `['--prompt', config.whisperPrompt]`
- 注意：`--prompt` 应该在 `extraArgs` 之前添加，以便用户可以通过 `WHISPER_ARGS` 覆盖

修改后的 args 构建逻辑：
```javascript
const promptArgs = config.whisperPrompt ? ['--prompt', config.whisperPrompt] : [];
const args = ['-m', modelPath, '-f', wavPath, '--output-txt', '--output-file', outBase, ...promptArgs, ...extraArgs];
```

**Step 3: 修改 src/whisper-server-manager.js**
- 在 `startWhisperServer` 函数中，构建 args 时添加 prompt 参数
- 如果 `config.whisperPrompt` 非空，添加 `['--prompt', config.whisperPrompt]` 到启动参数

修改位置（约第 72-77 行）：
```javascript
const args = [
  '--model', config.whisperModel,
  '--host', config.whisperServerHost,
  '--port', String(config.whisperServerPort),
  ...(config.whisperPrompt ? ['--prompt', config.whisperPrompt] : []),
  ...validServerArgs
];
```

**Step 4: 更新 .env.example**
- 在 `WHISPER_ARGS` 配置下方添加 `WHISPER_PROMPT` 示例
- 添加注释说明用途和最佳实践

添加内容：
```bash
# Prompt for guiding Whisper output (simplified Chinese + English mixed)
# This helps Whisper output simplified Chinese instead of traditional Chinese
# Keep under 224 tokens; use example text, not instructions
WHISPER_PROMPT=以下是普通话的句子。我在写代码，使用 function 定义函数，通过 API 调用接口。
```
  </action>
  <verify>
1. 确认 config.js 中 whisperPrompt 已添加：`grep -n "whisperPrompt" src/config.js`
2. 确认 whisper.js 中 prompt 参数传递：`grep -n "prompt" src/whisper.js`
3. 确认 whisper-server-manager.js 中 prompt 参数传递：`grep -n "prompt" src/whisper-server-manager.js`
4. 确认 .env.example 中新增配置：`grep -n "WHISPER_PROMPT" .env.example`
5. 验证服务启动无语法错误：`node --check src/server.js`
  </verify>
  <done>
- config.js 导出 whisperPrompt 配置项，默认值为简体中文编程示例
- whisper.js CLI 模式正确传递 --prompt 参数
- whisper-server-manager.js Server 模式正确传递 --prompt 参数
- .env.example 包含 WHISPER_PROMPT 配置示例和说明
- 服务可正常启动
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: 验证简体中文输出效果</name>
  <what-built>
Whisper Prompt 工程集成完成。通过 `--prompt` 参数传递简体中文示例文本，引导 Whisper 输出简体中文。
  </what-built>
  <how-to-verify>
**测试步骤：**

1. **启动服务：**
   ```bash
   cd /Users/jiabozhang/Documents/Develop/vibecoding/mac-whisper-ws-asr-server
   npm start
   ```

2. **确认日志中显示 prompt 配置（如果使用 Server 模式）：**
   观察启动日志，确认 whisper-server 启动参数中包含 `--prompt`

3. **测试简体中文识别：**
   - 使用 ESP32 或其他客户端录制并发送中文语音
   - 说一段简体中文内容，例如："我正在写一个函数来处理用户请求"
   - 观察返回的识别结果，确认是简体字（不是"處理"、"請求"等繁体字）

4. **测试英语识别：**
   - 说一段纯英语内容，例如："Create a new function to handle API requests"
   - 确认返回的是英语文本

5. **测试中英混合识别：**
   - 说一段中英混合内容，例如："这个 function 需要调用 API 来获取数据"
   - 确认中文部分是简体字，英语部分保持原样

**预期结果：**
- 简体中文输入 -> 简体中文输出
- 英语输入 -> 英语输出
- 中英混合输入 -> 简体中文 + 英语混合输出
- 不出现繁体字（除非用户明确说了繁体专有名词如"台灣"）

**如果仍有繁体字输出：**
记录具体的输入语音和输出文本，评估是否需要添加 OpenCC 后处理作为第二层防御。
  </how-to-verify>
  <resume-signal>
反馈测试结果：
- 如果简体中文输出正常，输入 "approved"
- 如果仍有繁体字泄漏，描述具体情况（什么输入产生了繁体输出），决定是否需要添加 OpenCC 后处理
  </resume-signal>
</task>

</tasks>

<verification>
Phase 4 验证检查：

1. **配置完整性：**
   - [ ] WHISPER_PROMPT 环境变量可配置
   - [ ] 默认值为简体中文编程示例

2. **集成完整性：**
   - [ ] CLI 模式（runWhisperCli）传递 --prompt 参数
   - [ ] Server 模式（startWhisperServer）传递 --prompt 参数

3. **功能验证：**
   - [ ] 简体中文输入 -> 简体中文输出
   - [ ] 英语输入 -> 英语输出
   - [ ] 中英混合输入 -> 简体中文 + 英语混合输出
</verification>

<success_criteria>
1. 用户说简体中文时，Whisper 输出结果为简体中文（不出现繁体字）
2. 用户说英语时，Whisper 输出结果为英语（不被强制转为中文）
3. 用户中英混合说话时，输出结果为简体中文+英语混合
4. 配置可通过 WHISPER_PROMPT 环境变量自定义
</success_criteria>

<output>
After completion, create `.planning/phases/04-whisper-output-normalization/04-01-SUMMARY.md`
</output>
